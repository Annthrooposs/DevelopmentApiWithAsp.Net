
using System.Text.Json;

using Microsoft.Extensions.Caching.Distributed;



namespace MinimalAPIProfesional;

public static class DistributedCacheExtensions         // Le mot-clé "static" est une pratique courante pour les classes utilitaires (dont les méthodes d'extension)
{

     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                Dependency injections                                                                                          !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Fields                                                                                                  !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Constants                                                                                                !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Properties                                                                                               !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Instances                                                                                               !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Indexers                                                                                                !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                        Events                                                                                                 !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Constructors                                                                                             !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                     Initialisations                                                                                           !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                   Synchronous methods                                                                                         !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     /// <summary>
     /// Gets a value from the distributed cache and deserializes it to the specified type.    
     /// </summary>
     /// <typeparam name="T"></typeparam>
     /// <param name="cache"></param>
     /// <param name="key"></param>
     /// <returns></returns>
     public static async Task<T?> GetAsync<T>(this IDistributedCache cache, string key) where T : class                                // Le where permet de spécifier que T doit être une classe
     {
          var json = await cache.GetStringAsync(key);

          if (string.IsNullOrEmpty(json))
          {
               return default;
          }
          else
          {
               return JsonSerializer.Deserialize<T>(json, new JsonSerializerOptions
                                                            {
                                                                 PropertyNameCaseInsensitive = true                                    // L'option "PropertyNameCaseInsensitive" précise que la désérialisation doit être insensible à la casse
                                                            });
          }
     }




     /// <summary>
     ///  Sets a value to the distributed cache and serializes it to the json type.
     /// </summary>
     /// <typeparam name="T"></typeparam>
     /// <param name="cache"></param>
     /// <param name="key"></param>
     /// <param name="value"></param>
     /// <returns></returns>
     public static async Task SetAsync<T>(this IDistributedCache cache, string key, T value) where T: class
     {
          var json = JsonSerializer.Serialize(value);
          await cache.SetStringAsync(key, json);
     }





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                  Asynchronous methods                                                                                         !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                               Standard operators redefined                                                                                    !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Unary operators -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Binary operators ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Conversion operators --------------------------------------------------------------------------------------------------------------------------------------------------------------------------





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                 Standard methods redefined                                                                                    !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // ToString() ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Equals() --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // HashCode() ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                        Nested types                                                                                           !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                          Finalizer                                                                                            !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Unmanaged resources ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
}
