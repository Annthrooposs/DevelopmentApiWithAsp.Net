
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration.UserSecrets;
using TP2_AméliorerlaMinimalAPIduTP1.Data;
using TP2_AméliorerlaMinimalAPIduTP1.Data.Models;
using TP2_AméliorerlaMinimalAPIduTP1.DTO;



namespace TP2_AméliorerlaMinimalAPIduTP1.Services;

public class EFCoreTodoService : ITodoService
{

     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                Dependency injections                                                                                          !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Fields                                                                                                  !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     private readonly ApiDbContext _context;





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Constants                                                                                                !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Properties                                                                                               !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Instances                                                                                               !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Indexers                                                                                                !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                        Events                                                                                                 !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Constructors                                                                                             !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     public EFCoreTodoService(ApiDbContext p_context)                                                                                                                                                 // Nous récupérons en paramètre le Service ApiDbContext injecté par le framework ASP.NET Core
     {
          _context = p_context;
     }





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                     Initialisations                                                                                           !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                   Synchronous methods                                                                                         !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Permet de transformer l'Output renvoyé en passant d'un Model à un autre manuellement ----------------------------------------------------------------------------------------------------------
     // Equivalent à l'outil communautaire "AutoMapper" : plus rapide mais moins ~sûr car nous pouvons 'oublier' une transformation -------------------------------------------------------------------
     //                                     ----------
     // ATTENTION : il est préférable de faire cette transformation dans le service et non dans le contrôleur, car le service est réutilisable par d'autres contrôleurs (ex : pour les tests unitaires)
     private TodoOutputDto ToOutputModel(Todo dbTodo) => new TodoOutputModel
               (
                    dbTodo.Id,
                    $"{dbTodo.FirstName} {dbTodo.LastName}",
                    dbTodo.Birthday == DateTime.MinValue ? null : dbTodo.Birthday
               );





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                  Asynchronous methods                                                                                         !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Endpoints                                                                                               !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // MapGET ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
     public async Task<List<TodoOutputDto>> GetAll()
     {
          return (await _context.TodoTable.ToListAsync()).ConvertAll(ToOutputModel);
     }



     public async Task<TodoOutputDto?> GetById(int p_id)
     {
          Todo? dbTodon = await _context.TodoTable.Where(w => w.Id == p_id).FirstOrDefaultAsync();

          if (dbTodon is not null)
          {
               return ToOutputModel(dbTodon);
          }
          else
          {
               return null;
          }
     }





     // MapPOST ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
     public async Task<TodoOutputDto> Add(TodoInputDto p_TodoInputModel)
     {
          Todo? dbTodo = new Todo
          {
               FirstName = p_TodoInputModel.FirstName,
               LastName  = p_TodoInputModel.LastName,
               Birthday  = p_TodoInputModel.Birthday.GetValueOrDefault()
          };
          
                    _context.TodoTable.Add(dbTodo);
          await     _context.SaveChangesAsync();


          return new TodoOutputModel
          (
               dbTodo.Id,
               $"{dbTodo.FirstName} {dbTodo.LastName}",
               dbTodo.Birthday == DateTime.MinValue ? null : dbTodo.Birthday
          );
     }





     // MapPUT ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
     public async Task<bool> Update(int p_id, TodoInputDto p_TodoInputModel)
     {
          return await _context.TodoTable
                              .Where(w => w.Id == p_id)
                              .ExecuteUpdateAsync(eua => eua.SetProperty(sp => sp.FirstName,   p_TodoInputModel.FirstName)
                                                            .SetProperty(sp => sp.LastName,    p_TodoInputModel.LastName)
                                                            .SetProperty(sp => sp.Birthday,    p_TodoInputModel.Birthday)) > 0;



          // ATTENTION : voici une version plus élaborée décrite dans : Développement d'API avec ASP.NET / TP 2 / Corrigé (part 3) / 08:45
          // -----------------------------------------------------------------------------------------------------------------------------

          // var dbTodo = await ContextBoundObject.Todos.FirstOrDefaultAsync(testc => testc.Id == id && testc.UserId == UserSecretsIdAttribute);
          // if (dbTodo is null) return false;

          // dbTodo.Title     = item.Title;
          // dbTodo.StartDate = item.StartDate ?? dbTodo.SartDate;
          // dbTodo.EndDate   = item.EndDate ?? dbTodo.EndDate;

          // context.Todos.Update(dbTodo);
          // return await context.SaveChangesAsync() > 0
     }





     // MapDELETE -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
     public async Task<bool> Delete(int p_id)
     {
          return await _context.TodoTable.Where(w => w.Id == p_id).ExecuteDeleteAsync() > 0;
     }





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                               Standard operators redefined                                                                                    !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Unary operators -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Binary operators ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Conversion operators --------------------------------------------------------------------------------------------------------------------------------------------------------------------------





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                 Standard methods redefined                                                                                    !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // ToString() ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Equals() --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // HashCode() ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                        Nested types                                                                                           !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                          Finalizer                                                                                            !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Unmanaged resources ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
}
