using Microsoft.EntityFrameworkCore;

using TP2_AméliorerlaMinimalAPIduTP1.Data.Models;



namespace Data;

public class ApiDbContext : DbContext
{

     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                Dependency injections                                                                                          !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Fields                                                                                                  !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Constants                                                                                                !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Properties                                                                                               !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     public DbSet<Todo> TodoTable { get; set; }
     public DbSet<User> UserTable { get; set; }





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Instances                                                                                               !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                       Indexers                                                                                                !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                        Events                                                                                                 !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                      Constructors                                                                                             !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Default constructor ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
     public ApiDbContext(DbContextOptions<ApiDbContext> options) : base(options)     // Remplace "protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)" (voir plus bas) pour rendre la connexion à la base de données configurable depuis l'extérieur et donc dynamique
     {
     }





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                     Initialisations                                                                                           !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                   Synchronous methods                                                                                         !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Configuration de l'accès aux bases de données -----------------------------------------------------------------------------------------------------------------------------------------------
     //protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
     //{
     //     // SqlLite
     //     //optionsBuilder.UseSqlite("Filename=api.db");

     //     // Sql Server
     //     optionsBuilder.UseSqlServer("Data Source = localhost; Initial Catalog = api_d; Trusted_Connection = True; Trust Server Certificate = true; Integrated Security = true; MultipleActiveResultSets = true");

     //     base.OnConfiguring(optionsBuilder);
     //}





     // Création du modèle ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
     protected override void OnModelCreating(ModelBuilder modelBuilder)
     {
          modelBuilder.Entity<Todo>(td =>
          {
               td.ToTable("TodoTable");
               td.HasKey(td => td.Id);

               td.Property(t => t.Title).HasMaxLength(1024);

               td.HasOne(o => o.User)
                    .WithMany(u => u.TodoTable).HasForeignKey(p => p.UserId)                        // Relation un-à-plusieurs entre Todo et User, avec UserId comme clé étrangère dans Todo
                    .OnDelete(DeleteBehavior.Cascade);                                              // Suppression en cascade pour les Todo liés à un User
          });
          //base.OnModelCreating(modelBuilder);


          modelBuilder.Entity<User>(u =>
          {
               u.ToTable("UserTable");
               u.HasKey(t => t.Id);

               u.Property(u => u.Name).HasMaxLength(256);
               u.Property(u => u.Token).HasMaxLength(16);

               u.HasMany(o => o.TodoTable).withOne(u => u.User).HasForeignKey(u => u.UserId);       // Relation un-à-plusieurs entre User et Todo, avec UserId comme clé étrangère dans Todo

               u.HasIndex(u => u.Token).IsUnique();                                                 // Index unique pour le Token de l'utilisateur
                    //.OnDelete(DeleteBehavior.Cascade);                                            // Suppression en cascade pour les User liés à un Todo
          });
     }





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                  Asynchronous methods                                                                                         !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                               Standard operators redefined                                                                                    !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Unary operators -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Binary operators ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Conversion operators --------------------------------------------------------------------------------------------------------------------------------------------------------------------------





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                 Standard methods redefined                                                                                    !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // ToString() ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // Equals() --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


     // HashCode() ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                        Nested types                                                                                           !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================





     // ===============================================================================================================================================================================================
     //                                                                                                                                                                                               !
     //                                                                                          Finalizer                                                                                            !
     //                                                                                                                                                                                               !
     // ===============================================================================================================================================================================================
     // Unmanaged resources ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
}
